<html>

<head>
    <link rel="stylesheet" type="text/css" media="screen" href="css/bootstrap.min.css" />
    <link rel="stylesheet" type="text/css" media="screen" href="css/jquery-ui.min.css" />
    <link rel="stylesheet" type="text/css" media="screen" href="css/main.css" />
    <script src="js/jquery.js"></script>
    <script src="js/jquery.js"></script>
    <script src="js/jquery-ui.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/flowdocode.js"></script>
    <script src="js/compiler.js"></script>

</head>

<body>
    <svg id="test">
        <defs>
            <marker id="arrowhead" viewBox="0 0 10 10" refX="10" refY="5" markerWidth="6" markerHeight="6"
                orient="auto">
                <path d="M 0 0 L 10 5 L 0 10 z" fill="#fff" />
            </marker>
        </defs>



    </svg>
    <style>
        g {
            fill: "none";
            stroke: #4f7df9;
            stroke-width: "2";
        }

        .a {
            width: 200px;
            height: 50px;
            min-width: 200px;
            max-width: 400px;
            z-index: 0;
            position: absolute;
            left: 500;
            top: 50;

        }

        #con2 {
            top: 300;
        }

        #con3 {
            left: 50;
        }

        svg {
            position: relative;
            top: 0px;
            padding: 0;
            width: 100%;
            height: 100%;
            z-index: 0;


        }


        path {
            width: 100%;
            height: auto;
        }

        .text {
            position: absolute;
            z-index: 1;

        }

        .con_anchor {
            width: 8px;
            height: 8px;
            background-color: #fff;
            border: 2px solid #4f7df9;
            z-index: 5;
            position: absolute;
            opacity: 0;
        }

        .anchor_top {
            top: -3;
            left: 100;
        }

        .anchor_right {
            top: 21;
            left: 195;
        }

        .anchor_bottom {
            top: 46;
            left: 100;
        }

        .anchor_left {
            top: 21;
            left: -3;
        }
        .hide{
            opacity: 0 !important;
        }
    </style>

    <div class="a" id="con" style="border: 0px solid ;">
        <div class="con_anchor anchor_top" data-point="top"></div>
        <div class="con_anchor anchor_right" data-point="right"></div>
        <div class="con_anchor anchor_bottom" data-point="bottom"></div>
        <div class="con_anchor anchor_left" data-point="left"></div>
        <svg stroke="red" fill="none">
            <path d="M 1 1 L 199 1 L 199 49 L 1 49 Z" />
        </svg>
        <div class="text text-center col-12  mx-auto" contenteditable="true">
            Process
        </div>


    </div>
    <div class="a" id="con2" style="border: 0px solid ;">
        <div class="con_anchor anchor_con2 anchor_top" data-point="top"></div>
        <div class="con_anchor anchor_con2 anchor_right" data-point="right"></div>
        <div class="con_anchor anchor_con2 anchor_bottom" data-point="bottom"></div>
        <div class="con_anchor anchor_con2 anchor_left" data-point="left"></div>
        <svg stroke="red" fill="none">
            <path d="M 1 1 L 199 1 L 199 49 L 1 49 Z" />
        </svg>
        <div class="text text-center col-12  mx-auto">
            Process
        </div>


    </div>
    <div class="a" id="con3" style="border: 0px solid ;">
        <div class="con_anchor anchor_con3 anchor_top" data-point="top"></div>
        <div class="con_anchor anchor_con3 anchor_right" data-point="right"></div>
        <div class="con_anchor anchor_con3 anchor_bottom" data-point="bottom"></div>
        <div class="con_anchor anchor_con3 anchor_left" data-point="left"></div>
        <svg stroke="red" fill="none">
            <path d="M 1 1 L 199 1 L 199 49 L 1 49 Z" />
        </svg>
        <div class="text text-center col-12  mx-auto">
            Process
        </div>


    </div>

</body>
<script>

    $(function () {

 
        $(".con_anchor").draggable({
            snap: ".con_anchor", opacity: 0.01,
            drag: function () {

                $(".con_anchor").css("opacity","1");
                $(this).addClass("hide");
                let currentPosition = $(this).offset();
                lineDraw = document.createElementNS("http://www.w3.org/2000/svg", "line");
                $(lineDraw).attr("id", "line_" + $(this).parent().prop("id"));

                let linePosition = {

                    x1: originalPosition.left + 4,
                    y1: originalPosition.top + 3,
                    x2: currentPosition.left + 5,
                    y2: currentPosition.top,

                    "data-from": "#" + $(this).parent().prop("id"),//ใช้บอกว่ามาจาก Node ไหน
                    "data-anchorfrom": $(this).attr("data-point")//ใช้บอกว่ามาจาก หมุด ตำแหน่งไหนของ Node ต้นทาง

                }

                $(lineDraw).addClass($(this).parent().prop("id"));
                //เพิ่ม class เพื่อบอก ว่า connector นี้ มีส่วนเชื่อมยังกับ Node(ต้นทาง) ใช้ check ตอน Node เกิดการเปลี่ยนแปลง


                $(lineDraw).attr(linePosition);
                //เพิ่ม attr position ให้ กับ line connector
                $(g).html($(lineDraw));
                


            }, stop: function () {

               
                if (successStatus) {
                    $(".con_anchor").css("opacity","0");

                    if ($(this).parent().attr("data-connector") != undefined) {
                        // data-connector คือ Node นั้นมี line ของตัวเองมั้ยแล้วชื่ออะไร
                        let connector = $(this).parent().attr("data-connector");
                        $(connector).parent("g").remove();
                    }
            
                    $(this).parent().attr("data-connector", "#" + $(lineDraw).prop("id"));
                    // $(this).addClass("hide");
                    successStatus = undefined;

                } else {
                    $(g).remove();
                }
                $(this).removeClass("hide");

                $(this).offset(originalPosition);
                console.log(lineDraw);
                let a=$(this).parent();
                a= a;
                console.log(a);
                // console.log($(this).parent());

            }

        });
        $(".con_anchor").droppable({
            accept: ".con_anchor",
            drop: function (event) {
                console.log("dropped");
                successStatus = true;
                lineAttr = {
                    "data-to": "#" + $(this).parent().prop("id"),
                    "data-anchorto": $(this).attr("data-point")
                }
                $(lineDraw).addClass($(this).parent().prop("id"));

                $(lineDraw).attr(lineAttr);

                $(lineDraw).offset();
                // $(this).addClass("hide");


            }
        });


   
        
        $(".a").hover(function () {
            $(this).find(".con_anchor").css("opacity", "1");
            $(document).on("mousedown",function(){
                 mouseDown=true;
            });
        }, function () {
            if(!mouseDown){
                $(this).find(".con_anchor").css("opacity", "0");
            }
            $(document).on("mouseup",function(){
                 mouseDown=false;
            });
            
        });
   
        $(".a").each(function () {
            updateTextboxPosition($(this));
            $(this).draggable({
                drag: function () {
                    let nodeId = $(this).prop("id");
                    $("line").each(function () {

                        if ($(this).hasClass(nodeId)) {
                            updateConnectorPosition($(this));
                        }

                    });



                }
            });
            $(this).resizable(
                {
                    handles: "e,  w", resize: function () {
                        updateSvgPath($(this), "process");
                        updateAnchorPosition($(this));
                        let nodeId = $(this).prop("id");
                    $("line").each(function () {

                        if ($(this).hasClass(nodeId)) {
                            updateConnectorPosition($(this));
                        }

                    });

                    }
                });
        });


    });
  
    function updateAnchorPosition(node) {
        updateAnchorTop(node);
        updateAnchorRight(node);
        updateAnchorBottom(node);
        updateAnchorLeft(node);
    }
    function getPropertyNode(node) {
        let nodePosition = $(node).offset();
        return {
            width: $(node).outerWidth(),
            height: $(node).outerHeight(),
            top: nodePosition.top,
            left: nodePosition.left
        }
    }
    function updateAnchorTop(node) {
        let anchor = $(node).find(".anchor_top");

        let nodeProperty = getPropertyNode(node);
        let position = {
            top: nodeProperty.top - 4,
            left: nodeProperty.left + (nodeProperty.width / 2) - 4
        }
        $(anchor).offset(position);
    }
    function updateAnchorRight(node) {
        let anchor = $(node).find(".anchor_right");
        let nodeProperty = getPropertyNode(node);
        let position = {
            top: nodeProperty.top + (nodeProperty.height / 2) - 4,
            left: nodeProperty.left + nodeProperty.width - 5
        }
        $(anchor).offset(position);

    }
    function updateConnectorPosition(node) {
        let fromNode = $($(node).attr("data-from"));
        let toNode = $($(node).attr("data-to"));
        let pointFrom = $(node).attr("data-anchorfrom");
        let pointTo = $(node).attr("data-anchorto");

        positionFromNode = getPositionByPoint(fromNode, pointFrom);
        positionToNode = getPositionByPoint(toNode, pointTo);
        let linePosition = {
            x1: positionFromNode.x,
            y1: positionFromNode.y,
            x2: positionToNode.x,
            y2: positionToNode.y

        }

        g = $(node).parent("g");
        node = $(node).attr(linePosition);
        $("#con-arrow").html($(node));


    }


    function getPositionByPoint(node, point) {
        // ไว้ให้ updateConnectorPosition เรียกเพื่อ return  ตำแหน่ง ของ connector โดยยึดตำแหน่งของ Anchor
        let positionNode = $(node).offset();
        switch (point) {
            case "top":
                return {
                    x: (positionNode.left + $(node).outerWidth() / 2) + 4,
                    y: positionNode.top
                }
                break;
            case "right":
                return {
                    x: positionNode.left + $(node).outerWidth(),
                    y: positionNode.top + $(node).outerHeight() / 2
                }
                break;
            case "bottom":
                return {
                    x: positionNode.left + $(node).outerWidth() / 2 + 4,
                    y: positionNode.top + $(node).outerHeight()
                }
                break;
            case "left":
                return {
                    x: positionNode.left,
                    y: positionNode.top + $(node).outerHeight() / 2
                }
                break;

        }
    }
    function updateAnchorBottom(node) {
        let anchor = $(node).find(".anchor_bottom");
        let nodeProperty = getPropertyNode(node);
        let position = {
            top: nodeProperty.top + (nodeProperty.height) - 4,
            left: (nodeProperty.left + (nodeProperty.width / 2)) - 4
        }
        $(anchor).offset(position);

    }

    function updateAnchorLeft(node) {
        let anchor = $(node).find(".anchor_left");
        let nodeProperty = getPropertyNode(node);
        let position = {
            top: nodeProperty.top + (nodeProperty.height / 2) - 4,
            left: nodeProperty.left - 3
        }
        $(anchor).offset(position);

    }

</script>

</html>