<!DOCTYPE html>

<html>

<head>
  <title>FlowdoCode | FLOWDOCODE</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" type="text/css" media="screen" href="../css/bootstrap.min.css" />
  <link rel="stylesheet" type="text/css" media="screen" href="../css/jquery-ui.min.css" />
  <link rel="stylesheet" type="text/css" media="screen" href="../css/main.css" />
  <script src="../js/jquery.js"></script>
  <script src="../js/jquery-ui.min.js"></script>
  <script src="../js/bootstrap.min.js"></script>
  <script src="../js/flowdocode.js"></script>
  <script src="../js/compiler.js"></script>



</head>

<body>

  <nav class="navbar navbar-expand-lg navbar-light bg-light ">
    <div class="collapse navbar-collapse" id="navbarNavDropdown">
      <ul class="navbar-nav">
        <!-- <li class="nav-item">
          <a class="nav-link " href="Basic.html">Basic</a>
        </li>
        <li class="nav-item">
          <a class="nav-link " href="Decision.html">Decision</a>
        </li>
        <li class="nav-item">
          <a class="nav-link " href="Loop.html">Loop</a>
        </li> -->

      </ul>
    </div>



  </nav>
  <svg id="canvas">
    <defs>
      <marker id="arrowhead" viewBox="0 0 10 10" refX="10" refY="5" markerWidth="6" markerHeight="6" orient="auto">
        <path d="M 0 0 L 10 5 L 0 10 z" fill="#fff" />
      </marker>
    </defs>



  </svg>
  <div class="col-2 con-fixed h-100 pb-5">
    <div class="my-5  toolbox start-end " id="start-end" draggable="true" ondragstart="drag(event)">
      <svg>
        <path d="M 25 1 C -5,1 -5,49 25,49 L 120 49 C 155,49 155,0 120,1 Z" />
      </svg>
      <!-- <div class="text text-center col-7  text-truncate mx-auto" >
                  End
                </div> -->
    </div>
    <div class="my-5 toolbox process" id="process" draggable="true" ondragstart="drag(event)">
      <svg>
        <path d="M 1 1 L 149 1 L 149 49 L 1 49 Z" />
      </svg>
      <!-- <div class="text text-center col-7  text-truncate mx-auto"  >
                  Process
                </div> -->
    </div>
    <div class="my-5  toolbox input" id="input" draggable="true" ondragstart="drag(event)">
      <svg>
        <path d="M 1 15 L 149 1 L 149 49 L 1 49 Z" />
      </svg>
      <!-- <div class="text text-center col-7  text-truncate mx-auto"  >
                  Input
                </div> -->
    </div>
    <div class="my-5  toolbox decision" id="decision" draggable="true" ondragstart="drag(event)">
      <svg>
        <path d="M 75 0 L 150 25 L 75 50 L 0 25 Z " />
      </svg>
      <!-- <div class="text text-center  col-7 text-truncate mx-auto"  >
                  Decision
                </div> -->
    </div>
    <div class="my-5 toolbox display" id="display" draggable="true" ondragstart="drag(event)">
      <svg>
        <path d="M 1 25 L 15 49 H 120 C 155 49 ,155 1, 120 1 H 15 L 1,25  " />
      </svg>
      <!-- <div class="text text-center col-7  text-truncate mx-auto"  >
                  Display
                </div> -->
    </div>


  </div>

  <div class="offset-2 col-8 py-0 con-fixed con-content h-75 "  ondragover="allowDrop(event)" ondrop="dropItem(event)">
    <div id="content">
      <div class="toolbox shape start-end " id="start">
        <div class="con_anchor anchor_start anchor_top" data-point="top"></div>
        <div class="con_anchor anchor_start anchor_right" data-point="right"></div>
        <div class="con_anchor anchor_start anchor_bottom" data-point="bottom"></div>
        <div class="con_anchor anchor_start anchor_left" data-point="left"></div>
        <svg>
    
          <path d="M 25 1 C -5,1 -5,49 25,49 L 175 49 C 200,49 200,1 175,1 Z" />
        </svg>
        <div class="text text-center col-12  text-truncate mx-auto">
          Start
        </div>
      </div>
    </div>


  
  
  </div>

  <div class="col-8 con-fixed h-25 p-3 offset-2 fixed-bottom " id="console" style="background: #fff;">
    Console
  </div>

  <div class="offset-10 col-2  con-fixed h-100">
    <button>Compile</button>
  </div>




</body>


<script>

  $(function () {

    $(".shape").each(function () {
      $(this).find(".con_anchor").draggable({
        snap: ".con_anchor", opacity: 0.01, drag: function () {
          $(".con_anchor").css("opacity", "1");
          $(this).addClass("hide");
          let currentPosition = $(this).offset();
          lineDraw = document.createElementNS("http://www.w3.org/2000/svg", "line");
          $(lineDraw).attr("id", "line_" + $(this).parent().prop("id"));

          let linePosition = {

            x1: originalPosition.left + 4,
            y1: originalPosition.top + 3,
            x2: currentPosition.left + 5,
            y2: currentPosition.top,

            "data-from": "#" + $(this).parent().prop("id"),//ใช้บอกว่ามาจาก Node ไหน
            "data-anchorfrom": $(this).attr("data-point")//ใช้บอกว่ามาจาก หมุด ตำแหน่งไหนของ Node ต้นทาง

          }

          $(lineDraw).addClass($(this).parent().prop("id"));
          //เพิ่ม class เพื่อบอก ว่า connector นี้ มีส่วนเชื่อมยังกับ Node(ต้นทาง) ใช้ check ตอน Node เกิดการเปลี่ยนแปลง


          $(lineDraw).attr(linePosition);
          //เพิ่ม attr position ให้ กับ line connector
          $(g).html($(lineDraw));
       
        }, stop: function () {


          if (successStatus) {
            $(".con_anchor").css("opacity", "0");

            if ($(this).parent().attr("data-connector") != undefined) {
              // data-connector คือ Node นั้นมี line ของตัวเองมั้ยแล้วชื่ออะไร
              let connector = $(this).parent().attr("data-connector");
              $(connector).parent("g").remove();
            }

            $(this).parent().attr("data-connector", "#" + $(lineDraw).prop("id"));

            successStatus = undefined;
          } else {
            $(g).remove();
          }
          $(this).removeClass("hide");

          $(this).offset(originalPosition);


        }
      });
      $(this).find(".con_anchor").droppable({
        accept: ".con_anchor",
        drop: function (event) {

          successStatus = true;
          lineAttr = {
            "data-to": "#" + $(this).parent().prop("id"),
            "data-anchorto": $(this).attr("data-point")
          }
          $(lineDraw).addClass($(this).parent().prop("id"));

          $(lineDraw).attr(lineAttr);

          $(lineDraw).offset();
          // $(this).addClass("hide");


        }
      });
      $(this).draggable({
        containment:"#content",drag: function () {
          let nodeId = $(this).prop("id");
          $("line").each(function () {

            if ($(this).hasClass(nodeId)) {
              updateConnectorPosition($(this));
            }

          });



        }
      });
      $(this).resizable({
          handles: "e,  w", resize: function () {
            updateSvgPath($(this), "process");
            updateAnchorPosition($(this));
            let nodeId = $(this).prop("id");
            $("line").each(function () {

              if ($(this).hasClass(nodeId)) {
                updateConnectorPosition($(this));
              }

            });

          }
        });
      updateAnchorPosition($(this));
      updateTextboxPosition($(this));
    });
    let p = {
      top: 87,
      left: 550
    }
    $("#start").offset(p);
    $(".shape").draggable();



  });

  function allowDrop(event) {
    event.preventDefault();
  }
  function drag(ev) {

    // ev.dataTransfer.setData("text", ev.target.getAttribute('data-type'));
    ev.dataTransfer.setData("text", ev.target.id);


  }  
  function dropItem(event) {


    event.preventDefault();
    try {

      var type = event.dataTransfer.getData("text");
      onDropItemSuccess(type);
    } catch (event) {
      var type = "";
    }






  }
  function onDropItemSuccess(type) {
    if (type != null) {

      if ($("#content").find("." + type + "").last().index() == -1) {
        var index = 0;
      } else {
        var str = $("#content").find("." + type + "").last().prop("id");
        str = str.split("-");
        var index = str[str.length - 1];
        index++;
      }
      let attrObj = {
        id: (type + "-" + index),
      }
      let mousePoint = {
        left: event.clientX - 100,
        top: event.clientY - 25
      }
      let node = $("template#" + type).html();

      node = $(node).draggable({
        containment:"#content",opacity: 0.5, drag: function () {
          shapeUnSelectedStyle();
          updateConnectorPositionOnAction(this);
          updateAnchorPosition(this);
          selectedEl = $(this);
        }
      });
      node = $(node).resizable({
        handles: "e", resize: function () {
          updateSvgPath(this, type);
          updateConnectorPositionOnAction(this);
          updateAnchorPosition(this);

        }
      });



      $("#content").append($(node));
      
      $(node).offset(mousePoint);
      $(node).prop(attrObj);
      $(node).find(".con_anchor").draggable({
        snap: ".con_anchor", opacity: 0.01, drag: function () {
         
          $(this).addClass("hide");
          $(".con_anchor").css("opacity", "1");
          let currentPosition = $(this).offset();
          lineDraw = document.createElementNS("http://www.w3.org/2000/svg", "line");
          $(lineDraw).attr("id", "line_" + $(this).parent().prop("id"));

          let linePosition = {

            x1: originalPosition.left + 4,
            y1: originalPosition.top + 3,
            x2: currentPosition.left + 5,
            y2: currentPosition.top,

            "data-from": "#" + $(this).parent().prop("id"),//ใช้บอกว่ามาจาก Node ไหน
            "data-anchorfrom": $(this).attr("data-point")//ใช้บอกว่ามาจาก หมุด ตำแหน่งไหนของ Node ต้นทาง

          }

          $(lineDraw).addClass($(this).parent().prop("id"));
          //เพิ่ม class เพื่อบอก ว่า connector นี้ มีส่วนเชื่อมยังกับ Node(ต้นทาง) ใช้ check ตอน Node เกิดการเปลี่ยนแปลง


          $(lineDraw).attr(linePosition);
          //เพิ่ม attr position ให้ กับ line connector
          $(g).html($(lineDraw));
        }, stop: function () {


          if (successStatus) {
            $(".con_anchor").css("opacity", "0");

            if ($(this).parent().attr("data-connector") != undefined) {
              // data-connector คือ Node นั้นมี line ของตัวเองมั้ยแล้วชื่ออะไร
              let connector = $(this).parent().attr("data-connector");
              $(connector).parent("g").remove();
            }

            $(this).parent().attr("data-connector", "#" + $(lineDraw).prop("id"));

            successStatus = undefined;

          } else {
            $(g).remove();
          }
          $(this).removeClass("hide");

          $(this).offset(originalPosition);


        }
      });
      $(node).find(".con_anchor").droppable({
        accept: ".con_anchor",
        drop: function (event) {

          successStatus = true;
          lineAttr = {
            "data-to": "#" + $(this).parent().prop("id"),
            "data-anchorto": $(this).attr("data-point")
          }
          $(lineDraw).addClass($(this).parent().prop("id"));

          $(lineDraw).attr(lineAttr);

          $(lineDraw).offset();
          // $(this).addClass("hide");


        }
      });
      
      updateTextboxPosition(node);
      updateAnchorPosition(node);
    }
  }


  $("div").on("click", ".shape", function () {
    if ($(selectedEl).prop("id") != $(this).prop("id")) {
      shapeUnSelectedStyle();
    }
    selectedEl = $(this);
    shapeSelectedStyle();
    $(document).keydown(function (event) {
      if ((event.keyCode == 8 || event.keyCode == 46) && $(selectedEl).find("div.text").prop("contenteditable") != "true") {
        if ($(selectedEl).prop("id") != "start")
          $(selectedEl).remove();
      }
      if (event.keyCode == 13) {
        disContentEdit();
        shapeUnSelectedStyle();
      }
    });



    $("div").on("click", ".text", function () {
      if (!$(selectedEl).hasClass("start-end")) {
        document.body.style.cursor = "";
        $(selectedEl).find("div.text").prop("contenteditable", true);
        $(selectedEl).draggable({ disabled: true });
      }

    });
    $("div").on("blur", ".text", function () {

      disContentEdit();

    });




  });


  $("#content").on("mouseup", function (event) {
    if (event.target === this) {
      shapeUnSelectedStyle();

    }

  });


  $(document).on("mouseenter", ".shape", function () {
    document.body.style.cursor = "grab";
    if($(selectedEl).prop("id") != $(this).prop("id")){
      $(this).find(".con_anchor").css("opacity", "1");
      $(document).on("mousedown", function () {
        mouseDown = true;
     

      });
    }
 });
  $(document).on("mouseleave", ".shape", function () {
    document.body.style.cursor = "";
    if (!mouseDown) {
      $(this).find(".con_anchor").css("opacity", "0");
    }
    $(document).on("mouseup", function () {
      mouseDown = false;
    });
  });


  $(document).on("mouseup", ".shape", function () {
    if (selectedEl == undefined) {
      selectedEl = $(this);

    }
    shapeSelectedStyle();
    document.body.style.cursor = "grab";
  });

  $(document).on("mousedown", ".con_anchor", function () {

      originalPosition = $(this).offset();
      g = document.createElementNS("http://www.w3.org/2000/svg", "g");
      g = $(g).attr("marker-end", "url(#arrowhead)");
      g = $(g).attr("stroke-width", "2");

      $("#canvas").append($(g));
  });


  $(".con-content").on("scroll",function(){
    $("line").each(function () {
          updateConnectorPosition($(this));

    });
  });










</script>
<scrip type="text/template">

  <template id="start-end">
    <div class="shape start-end ">
      <div class="con_anchor  anchor_top" data-point="top"></div>
      <div class="con_anchor  anchor_right" data-point="right"></div>
      <div class="con_anchor  anchor_bottom" data-point="bottom"></div>
      <div class="con_anchor  anchor_left" data-point="left"></div>

      <svg>
        <path d="M 25 1 C -5,1 -5,49 25,49 L 175 49 C 200,49 200,1 175,1 Z" />
      </svg>
      <div class="text text-center col-12  text-truncate mx-auto ">
        End
      </div>
    </div>
  </template>
  <template id="process">
    <div class="shape process ">
      <div class="con_anchor  anchor_top" data-point="top"></div>
      <div class="con_anchor  anchor_right" data-point="right"></div>
      <div class="con_anchor  anchor_bottom" data-point="bottom"></div>
      <div class="con_anchor  anchor_left" data-point="left"></div>
      <svg>
        <path d="M 1 1 L 199 1 L 199 49 L 1 49 Z" />
      </svg>
      <div class="text text-center col-12  text-truncate mx-auto" contenteditable=false>
        Process
      </div>
    </div>
  </template>
  <template id="input">
    <div class="shape input">
      <div class="con_anchor  anchor_top" data-point="top"></div>
      <div class="con_anchor  anchor_right" data-point="right"></div>
      <div class="con_anchor  anchor_bottom" data-point="bottom"></div>
      <div class="con_anchor  anchor_left" data-point="left"></div>
      <svg>
        <path d="M 1 15 L 199 1 L 199 49 L 1 49 Z" />
      </svg>
      <div class="text text-center col-12  text-truncate mx-auto" contenteditable=false>
        Input
      </div>
    </div>
  </template>
  <template id="decision">
    <div class=" shape decision ">
      <div class="con_anchor  anchor_top" data-point="top"></div>
      <div class="con_anchor  anchor_right" data-point="right"></div>
      <div class="con_anchor  anchor_bottom" data-point="bottom"></div>
      <div class="con_anchor  anchor_left" data-point="left"></div>
      <svg>
        <path d="M 100 1 L 199 25 L 100 49 L 1 25 Z " />
      </svg>
      <div class="text text-center col-12  text-truncate mx-auto" contenteditable="false">
        Decision
      </div>
    </div>
  </template>
  <template id="display">
    <div class=" shape display ">
      <div class="con_anchor  anchor_top" data-point="top"></div>
      <div class="con_anchor  anchor_right" data-point="right"></div>
      <div class="con_anchor  anchor_bottom" data-point="bottom"></div>
      <div class="con_anchor  anchor_left" data-point="left"></div>
      <svg>
        <path d="M 1 25 L 15 49 H 180 C 205 49 ,205 1, 180 1 H 15 L 1,25  " />
      </svg>
      <div class="text text-center col-12  text-truncate mx-auto" contenteditable="false">
        Display
      </div>
    </div>
  </template>





</scrip>

</html>