<!DOCTYPE html>

<html>

<head>
  <title>FlowdoCode | FLOWDOCODE</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" type="text/css" media="screen" href="css/bootstrap.min.css" />
  <link rel="stylesheet" type="text/css" media="screen" href="css/jquery-ui.min.css" />
  <link rel="stylesheet" type="text/css" media="screen" href="css/font-awesome-all.min.css" />
  <link rel="stylesheet" type="text/css" media="screen" href="css/main.css" />
  <!-- <link rel="stylesheet" type="text/css" media="screen" href="css/darktheme.css" /> -->



  <script src="js/jquery.js"></script>
  <script src="js/jquery-ui.min.js"></script>

  <script src="js/popper.min.js"></script>

  <script src="js/bootstrap.min.js"></script>


  <script src="js/flowdocode.js"></script>
  <script src="js/pseudocode.js"></script>
  <script src="js/compiler.js"></script>
  <script src="js/debugger.js"></script>
  <script src="js/syntaxchecker.js"></script>
  <script src="js/font-awesome-all.min.js"></script>
  <script src="js/vue.js"></script>
  <script src="js/events.js"></script>

  <script src="js/jquery.md5.js"></script>


</head>

<body>

  <nav class="navbar navbar-expand-lg   p-0">
    <div class="col-12 m-0 p-0">
      <!-- flex-column -->
      <!--         <input class="form-control col-4 mt-2" id="assignment" placeholder="Assignment" value="untitled">
 -->
      <ul class="navbar-nav p-0">


        <li class="nav-item dropdown">
          <a class="nav-link " href="#" data-toggle="dropdown">File</a>
          <div class="dropdown-menu">
            <label> <a class="dropdown-item" id="save">Save</a></label>
            <label><a class="dropdown-item" id="saveall">Save All</a></label>

            <label><a class="dropdown-item" id="open">
                Open
                <input type="file" id="openfile" accept="text/*,.fdc">

              </a></label>
            <label> <a class="dropdown-item" id="pseudoCode" ><label>PseudoCode</label></a></label>
          </div>
        </li>
        <li class="nav-item">
          <a class="nav-link " href="test.html" target="_blank">Edit</a>
        </li>
        <li class="nav-item">
          <a class="nav-link ">Help</a>
        </li>
        <div class="col-2 py-2 px-0 mx-auto">
          <ul class="navbar-nav  p-0 justify-content-center">
            <li class="nav-item ">
              <button class="btn btn-sm btn-flowdocode px-2 mt-1" id="play"><i class='fas fa-play'></i></button>
              <button class="btn btn-sm btn-flowdocode px-2 mt-1" id="debug"><i class="fas fa-bug"></i></button>
              <button class="btn btn-sm btn-flowdocode px-2 mt-1" id="stop"><i class='fas fa-stop'></i></button>
              <button class="btn btn-sm btn-flowdocode px-2 mt-1" id="play-refresh">
                <i class="fas fa-redo-alt"></i>
              </button>
              <button class="btn btn-sm btn-flowdocode px-2 ondebug mt-1" id="refresh">
                  <i class="fas fa-redo-alt"></i>
                </button>
              <button class="btn btn-sm btn-flowdocode px-2 ondebug mt-1" id="next">
                <i class="fas fa-step-forward"></i>
              </button>
                <button class="btn btn-sm btn-flowdocode px-2 ondebug mt-1"id="skip">
                  <i class="fas fa-fast-forward"></i>
                </button>
                 
                    <button class="btn btn-sm btn-flowdocode px-2 mt-1" id="i">ee</button>


            </li>
          </ul>
        </div>
      </ul>

      <!--     <ul class="navbar-nav flex-row mb-2">
        
      </ul> -->
    </div>







  </nav>


  <div class="col-2 con-fixed h-100 pb-5 p-0" id="con-toolbox">
    <p class="header py-1 m-0 col-12">TOOLBOX</p>
    <div class="my-5  toolbox start-end " id="start-end" draggable="true" ondragstart="drag(event)"
      data-toggle="tooltip" data-placement="bottom" title="End">
      <svg>
        <path d="M 25 1 C -5,1 -5,49 25,49 L 120 49 C 155,49 155,0 120,1 Z" />
      </svg>

    </div>
    <div class="my-5 toolbox process" id="process" draggable="true" ondragstart="drag(event)" data-toggle="tooltip"
      data-placement="bottom" title="Process">
      <svg>
        <path d="M 1 1 L 149 1 L 149 49 L 1 49 Z" />
      </svg>

    </div>
    <div class="my-5  toolbox input" id="input" draggable="true" ondragstart="drag(event)" data-toggle="tooltip"
      data-placement="bottom" title="input">
      <svg>
        <path d="M 1 15 L 149 1 L 149 49 L 1 49 Z" />
      </svg>

    </div>
    <div class="my-5  toolbox decision" id="decision" draggable="true" ondragstart="drag(event)" data-toggle="tooltip"
      data-placement="bottom" title="decision">
      <svg>
        <path d="M 75 1 L 150 25 L 75 50 L 1 25 Z " />
      </svg>

    </div>
    <div class="my-5 toolbox display" id="display" draggable="true" ondragstart="drag(event)" data-toggle="tooltip"
      data-placement="bottom" title="display">
      <svg>
        <path d="M 1 25 L 15 49 H 120 C 155 49 ,155 1, 120 1 H 15 L 1,25  " />
      </svg>

    </div>
<div id="version"style="color:#fff">v.1.0.0.7</div>

  </div>
  <div class="offset-2 col-8 p-0 btn-group " id="pagination">
    <button class="btn btn-flowdocode" id="addpage"><i class="fas fa-plus-circle"></i></button>

  </div>
  <div class="offset-2 col-8 p-0 pb-5  mb-5 " id="con-design" style="position: fixed;overflow-y:scroll;">

    <div id="design" class=" col-12 p-0 con-design" ondragover="allowDrop(event)" ondrop="dropItem(event)">
      <div id="design-containment" ></div>
      <svg id="canvas">
        <defs>
          <marker id="arrowhead" viewBox="0 0 10 10" refX="10" refY="5" markerWidth="6" markerHeight="6" orient="auto">
            <path d="M 0 0 L 10 5 L 0 10 z" />
          </marker>
        </defs>
      </svg>
      <div class=" shape start-end " id="start">
        <div class="con_anchor anchor_start anchor_top" data-point="top"></div>
        <div class="con_anchor anchor_start anchor_right" data-point="right"></div>
        <div class="con_anchor anchor_start anchor_bottom" data-point="bottom"></div>
        <div class="con_anchor anchor_start anchor_left" data-point="left"></div>
        <svg>

          <path d="M 25 1 C -5,1 -5,49 25,49 L 180 49 C 205,49 205,1 180,1 Z" />
        </svg>
        <div class="text text-center col-12  text-truncate mx-auto">
          Start
        </div>
      </div>





    </div>
  </div>







  <div class="col-8  h-25 p-0 offset-2 fixed-bottom  " id="con-console">
    <p class="header py-1 m-0 "> Output</p>
    <div class="my-2 mb-5 m-0 px-4 " id="console">

    </div>



  </div>

  <div class="offset-10 col-2 p-0 h-100 " id="con-right" >
    <p class="header py-1  m-0 col-12"> Debugger</p>
    <div class="col-12 p-0 m-0 row header" style="display: flex;"> 
      <div class="col-4 debugger-header py-2" >Action</div>
      <div class="col-4 debugger-header py-2">Variable</div>
      <div class="col-4 debugger-header py-2">Value</div>

    </div>
    <div class="col-12  p-0 pb-5 " id="con-debugger" style="overflow-y: scroll !important;"> 
      
      <table class="table table-dark table-striped m-0">
     
        <tbody id="debugger" class="text-center"style="overflow-y: scroll !important;">


        </tbody>
      </table>
    </div>

    <!-- <div class="col-12 p-0  h-50 m-0  ">
      <p class="header py-1 m-0 "> Properties</p>
      <div class="row p-0 con-property">
        <div class="col-6 pl-4 font-weight-bold">Name</div>
        <input class="col-6" id="name" v-model="name" readonly>

        <div class="col-6 pl-4 font-weight-bold">Type</div>
        <select class="col-6" id="type" v-model="name">
          <option value="process">Process</option>
          <option value="input">Input</option>
          <option value="decision">Decision</option>
          <option value="display">Display</option>

        </select>

        <div class="col-6 pl-4 font-weight-bold">Code</div>
        <input class="col-6" id="code" value="aaad" readonly>

        <div class="col-6 pl-4 font-weight-bold">Width</div>
        <input class="col-6" id="width" value="aaad" readonly>

        <div class="col-6 pl-4 font-weight-bold">Height</div>
        <input class="col-6" id="Height" value="aaad" readonly>

        <div class="col-6 pl-4 font-weight-bold">Location</div>
        <input class="col-6" id="location" value="aaad" readonly>



      </div>

    </div> -->

  </div>


  <div class="modal fade" id="InputDialog" data-backdrop="false" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Input Box</h5>

        </div>
        <div class="modal-body">
          <div class="form-group">
            <label id="inputtitle"></label>
            <input type="text" class="form-control" id="inputBox" autofocus>
            <small id="emailHelp" class="form-text text-muted">If value is string you must assign in " " Or ' '</small>
          </div>
        </div>
     
      </div>
    </div>
  </div>

</body>


<script>
  $("#i").click(function () {
    // /* listVariable();
    // checkSyntax(); */
    // checkProcessAssignVar();
    pseudocodeController();
  });
  $("#con-design").scroll(function () {
  });
  $(function () {

    // let w = new Worker("js/worker.js");
    // w.postMessage('d');
    // w.onmessage=function(e){
      
    //   console.log(e);
    // }
    let list=[];
    for(let i =0;i<sessionStorage.length;i++){
      list.push(sessionStorage.key(i));
    }
    list.sort();
    list.sort((a,b)=>{    
    return compare(a,b);
  });
      for(let i =0;i<list.length;i++){
      let sessionKey = list[i];
      let sessionVal=sessionStorage.getItem(sessionKey);
      let size=3 + ((sessionVal.length*16)/(8*1024)) + ' KB'
      console.log(size);
      try{
        sessionVal=JSON.parse(sessionVal);

      }catch(e){
        console.log('can\'t Convert Json');
        console.log(e);
        continue;
      }
      if(sessionVal.design==undefined||sessionVal.resolution==undefined){
        console.log(sessionKey+'   Data Incomplete');
        continue;

      }
    

      addToStorageCache(sessionKey,sessionStorage.getItem(sessionKey));
      writeCodeToDesign(sessionStorage.getItem(sessionKey));
    }
    if(sessionStorage.length<=1){
      init();
    }else{
      init(true);
    }
    // sessionStorage.clear();

    //ปรับ resolution ตามขนาดจอที่เปิด อันนี้เอาค่าจากเครื่องต้นทาง
    //     console.log(window.screen.availHeight,
    // window.screen.availWidth);
    // $( "#content" ).selectable();    

   

  });

  function allowDrop(event) {
    event.preventDefault();
  }
  function drag(ev) {

    // ev.dataTransfer.setData("text", ev.target.getAttribute('data-type'));
    ev.dataTransfer.setData("text", ev.target.id);


  }
  function dropItem(event) {


    event.preventDefault();
    try {

      var type = event.dataTransfer.getData("text");

      onDropItemSuccess(type);
    } catch (event) {
      var type = "";
    }






  }
  $(document).on("DOMSubtreeModified","#design",function(){
    // let presentPage=$(".active").attr("data-page");
    // sessionStorage.setItem(presentPage,$("#design").html())
   
    // readPage(presentPage, "switch");
  });
  $(document).on("dblclick",".toolbox",function(){
    let node =getLatestNode() ;
    let position=$(node).offset();
    onDropItemSuccess($(this).prop("id"),position.left+100,position.top+120);
  });
  $(document).on("mouseenter", "tr", function () {
    let node = $(this).attr("data-node");
    if (!onDebug) {
      
      $(node).find("svg").css("stroke", "#f1c40f");
      $(node).addClass("font-weight-bold");
      $(this).addClass("font-weight-bold");
     
     
    }
    if($(node).offset().top>$(document).height()*70/100){
        let height=$(node).offset().top-$(document).height()*50/100;
      
        $("#con-design").animate({scrollTop:height}, "fast");
      }else if($(node).offset().top<$(document).height()*15/100){
        let height=$(node).offset().top-$(document).height()*50/100;
      
        $("#con-design").animate({scrollTop:height}, "fast");
    }

  });
  $(document).on("mouseleave", "tr", function () {
    if (!onDebug) {

      let node = $(this).attr("data-node");
      $(node).find("svg").css("stroke", "#4f7df9");
      $(node).removeClass("font-weight-bold");
      $(this).removeClass("font-weight-bold");
    }
  });


  $("div").on("click", ".shape", function () {
    // click select shape 
    actionOnSelectElement(this);





  });
  $(document).keydown(function (event) {

    if ((event.keyCode == 8 || event.keyCode == 46) && $(selectedEl).find("div.text").prop("contenteditable") != "true") {
      if ($(selectedEl).prop("id") != "start") {
        if ($(selectedEl).hasClass("shape")) {
          checkConnectorOnNodeDelete(selectedEl);

          $(selectedEl).remove();
          hasEnd();
        } else {
          onConnectorDelete(selectedEl);
          $(selectedEl).parent("g").remove();

        }

      }
    }
    if (event.keyCode == 13) {
      disContentEdit();

      shapeUnSelectedStyle();
    }
  });



  $("div").on("dblclick", ".text", function () {
    if (!$(selectedEl).hasClass("start-end")) {
      document.body.style.cursor = "";
      if (getNodeType(selectedEl) == $(selectedEl).find("div.text").text().trim().toLowerCase()) {
        $(selectedEl).find("div.text").empty();

      }
      $(selectedEl).find("div.text").prop("contenteditable", true);
      $(selectedEl).find("div.text").focus();
      /*       console.log($(selectedEl).find("div.text").text().trim());
            console.log(getNodeType(selectedEl)); */



      $(selectedEl).draggable({ disabled: true });

    }

  });
  $("div").on("blur", ".text", function () {
    if ($(selectedEl).find("div.text").text().trim().toLowerCase() == "") {
      $(selectedEl).find("div.text").text(getNodeType(selectedEl));

    } else if ($(selectedEl).hasClass("process")) {

    }

    disContentEdit();
    $(this).find(".con_anchor").css("opacity", "0");

  });
  function actionOnSelectElement(el) {
    if ($(selectedEl).prop("id") != $(el).prop("id")) {
      shapeUnSelectedStyle();
    }
    selectedEl = $(el);

    shapeSelectedStyle();
  }

  $(document).on("click", "polyline", function () {
    actionOnSelectElement(this);

  });

  $(document).on("mouseup", "#canvas", function (event) {
    if (event.target === this) {

      shapeUnSelectedStyle();

    }

  });
  $(document).on("mouseenter", "polyline", function () {//event mouse hover on shape show anchor

    document.body.style.cursor = "grab";

  });

  $(document).on("mouseleave", "polyline", function () {  //event mouse leave on shape hide anchor

    document.body.style.cursor = "";

  });

  $(document).on("mouseenter", ".con_anchor", function () {
    document.body.style.cursor = "grab";

    onHoverAnchor = true;
  });
  $(document).on("mouseleave", ".con_anchor", function () {
    document.body.style.cursor = "move";
    onHoverAnchor = undefined;
  });
  $(document).on("mousemove", ".text", function () {
    if ($(this).prop("contenteditable") == true) {
      document.body.style.cursor = "text";

    }

  });
  $(document).on("mouseleave", ".text", function () {
    document.body.style.cursor = "move";
  });


  $(document).on("mouseenter", ".shape", function () {//event mouse hover on shape show anchor
    if (onHoverAnchor == undefined)
      document.body.style.cursor = "move";


    if ($(selectedEl).prop("id") != $(this).prop("id")) {


      updateAnchorPosition($(this));
      $(this).find(".con_anchor").css("opacity", "1");

      $(document).on("mousedown", function () {

        mouseDown = true;


      });
    }
    if (selectedEl == undefined) {
      mouseDown = false;
    }
  });


  $(document).on("mouseleave", ".shape", function () {  //event mouse leave on shape hide anchor

    document.body.style.cursor = "";
    if (!mouseDown) {
      $(this).find(".con_anchor").css("opacity", "0");
    }
    $(document).on("mouseup", function () {
      mouseDown = false;
    });
  });


  $(document).on("mouseup", ".shape", function () {
    if (selectedEl == undefined) {
      selectedEl = $(this);
    }

    shapeSelectedStyle();
    document.body.style.cursor = "grab";
  });

  $(document).on("mousedown", ".con_anchor", function () {

    originalPosition = $(this).offset();
    g = document.createElementNS("http://www.w3.org/2000/svg", "g");
    g = $(g).attr("marker-end", "url(#arrowhead)");
    g = $(g).attr("stroke-width", "2");

    $("#canvas").append($(g));

  });

  $(document).on("keyup", "#inputBox", function (e) {
    let regex = /(^[0-9]+|^\'[^\\\/\;\'\"]+\'|^\"[^\\\/\;\'\"]+\")$/gm;
    if ($(this).val() != "" && regex.test($(this).val())) {
      $(this).removeClass('input_invalid');
      if (event.keyCode == 13 ) {


        inputSuccess = true;
        $("#InputDialog").modal("hide");
       



        

        /*         return false;
        */
      }
    } else {
      $(this).addClass('input_invalid');
    }
  });
  $('#InputDialog').on('hidden.bs.modal', function (e) {
      compileContinue();
    })
  $(document).on("click", "#saveall", function () {

    saveAll();



    // $(this).parent().dropdown('toggle');

  });
  $(document).on("click", "#save", function () {
    let fileName = $(".active").attr("data-page");

    save(fileName);

    // $(this).parent().dropdown('toggle');

  });
  $(document).on("change", "#open", function () {
    openFile();
  });
  $(document).on("click", ".page", function () {
    if (!$(this).hasClass("active") && onClose != true) {
      readPage($(this), "switch");
    }
    onClose = false;
    $("#console").empty();
    $("#debugger").empty();
  });
  $(document).on("click", "#addpage", function () {

    let width = $(window).width();
    let height = $(window).height();
    let text = { "design": $("#design").html(), "resolution": { "width": width, "height": height } };
    let page = $(".active").attr("data-page");
    sessionStorage.setItem(page, JSON.stringify(text));
    $("#design").html($("#newpage").html());
    init();

  });
  $(document).on("click", ".close", function () {

    onClose = true;
    if ($(".page").length == 1 || $(this).parent(".page").hasClass("page-edit")) {
      return false;
    }
    let nextPage = "#";
    let index = $(this).parent(".page").index();

    if (index == $(".page").length) {
      nextPage += $(".page").eq(index - 2).prop("id");
    } else {
      nextPage += $(".page").eq(index).prop("id");

    }

    if ($(this).parent(".page").hasClass("active")) {
      console.log(typeof nextPage);
      readPage(nextPage);
    }
    sessionStorage.removeItem($(this).parent(".page").attr("data-page"));
    $(this).parent(".page").remove();
  });
  $(document).on("dblclick", ".page", function () {
    currentPageName = $(this).find('.page-text').text();
    $(this).attr("contenteditable", "true");

    $(this).addClass("page-edit");
    $(this).focus();


  });
  $(document).on("keydown", ".page", function () {
    if (event.keyCode == 13) {
      $(this).trigger("blur");
      // changePageName(this);
      return false;
    }
  });
  $(document).on("blur", ".page", function () {
      changePageName(this);

   

  });

 
</script>


<template id="start-end">
  <div class="shape start-end ">
    <div class="con_anchor  anchor_top" data-point="top"></div>
    <div class="con_anchor  anchor_right" data-point="right"></div>
    <div class="con_anchor  anchor_bottom" data-point="bottom"></div>
    <div class="con_anchor  anchor_left" data-point="left"></div>

    <svg>
      <path d="M 25 1 C -5,1 -5,49 25,49 L 180 49 C 205,49 205,1 180,1 Z" />
    </svg>
    <div class="text text-center col-12  text-truncate mx-auto ">
      End
    </div>
  </div>
</template>
<template id="process">
  <div class="shape process ">
    <div class="con_anchor  anchor_top" data-point="top"></div>
    <div class="con_anchor  anchor_right" data-point="right"></div>
    <div class="con_anchor  anchor_bottom" data-point="bottom"></div>
    <div class="con_anchor  anchor_left" data-point="left"></div>
    <svg>
      <path d="M 1 1 L 199 1 L 199 49 L 1 49 Z" />
    </svg>
    <div class="text text-center col-12  text-truncate mx-auto" contenteditable=false>
      process
    </div>
  </div>
</template>
<template id="input">
  <div class="shape input">
    <div class="con_anchor  anchor_top" data-point="top"></div>
    <div class="con_anchor  anchor_right" data-point="right"></div>
    <div class="con_anchor  anchor_bottom" data-point="bottom"></div>
    <div class="con_anchor  anchor_left" data-point="left"></div>
    <svg>
      <path d="M 1 15 L 199 1 L 199 49 L 1 49 Z" />
    </svg>
    <div class="text text-center col-12  text-truncate mx-auto" contenteditable=false>
      input
    </div>
  </div>
</template>
<template id="decision">
  <div class=" shape decision ">
    <div class="con_anchor  anchor_top" data-point="top"></div>
    <div class="con_anchor  anchor_right" data-point="right"></div>
    <div class="con_anchor  anchor_bottom" data-point="bottom"></div>
    <div class="con_anchor  anchor_left" data-point="left"></div>
    <svg>
      <path d="M 100 1 L 199 25 L 100 49 L 1 25 Z " />
    </svg>
    <div class="text text-center col-12  text-truncate mx-auto" contenteditable="false">
      decision
    </div>
  </div>
</template>
<template id="display">
  <div class=" shape display ">
    <div class="con_anchor  anchor_top" data-point="top"></div>
    <div class="con_anchor  anchor_right" data-point="right"></div>
    <div class="con_anchor  anchor_bottom" data-point="bottom"></div>
    <div class="con_anchor  anchor_left" data-point="left"></div>
    <svg>
      <path d="M 1 25 L 15 49 H 180 C 205 49 ,205 1, 180 1 H 15 L 1,25  " />
    </svg>
    <div class="text text-center col-12  text-truncate mx-auto" contenteditable="false">
      display
    </div>
  </div>
</template>
<template id="newpage">
  <div id="design-containment" style="position:fixed;"></div>
  <svg id="canvas">
    <defs>
      <marker id="arrowhead" viewBox="0 0 10 10" refX="10" refY="5" markerWidth="6" markerHeight="6" orient="auto">
        <path d="M 0 0 L 10 5 L 0 10 z" />
      </marker>
    </defs>
  </svg>
  <div class=" shape start-end " id="start">
    <div class="con_anchor anchor_start anchor_top" data-point="top"></div>
    <div class="con_anchor anchor_start anchor_right" data-point="right"></div>
    <div class="con_anchor anchor_start anchor_bottom" data-point="bottom"></div>
    <div class="con_anchor anchor_start anchor_left" data-point="left"></div>
    <svg>

      <path d="M 25 1 C -5,1 -5,49 25,49 L 180 49 C 205,49 205,1 180,1 Z" />
    </svg>
    <div class="text text-center col-12  text-truncate mx-auto">
      Start
    </div>
  </div>
</template>



</html>